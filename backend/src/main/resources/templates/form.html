<!-- src/main/resources/templates/form.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/layout :: layout(~{::title}, ~{::style}, ~{::.page-content}, ~{::script})}" lang="pl">
<head>
    <title>Formularz Predykcji Anemii</title>
    <style>
        /* Style specyficzne TYLKO dla form.html, jeśli są */
        /* Przykład: styl dla loading state przycisku submit */
        button[type="submit"].loading {
            /* Dodaj tu style wizualne dla loading state, np. zmiana koloru, ikonka */
            background-color: #0288d1; /* Ciemniejszy niebieski podczas loading */
            cursor: progress;
            /* Możesz dodać ikonę, np. Font Awesome: */
            /* &::after { content: " \f110"; font-family: "Font Awesome 5 Free"; animation: spin 1s linear infinite; } */
        }
        /* Opcjonalnie: animacja obracania ikonki Font Awesome */
        /* @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } */
    </style>
</head>
<body>
<div class="page-content">
    <h2>Formularz Predykcji Anemii</h2>
    <form id="blood-form" class="form-container">
        <!-- Pola formularza (jak poprzednio) -->
        <div class="form-group">
            <label for="RBC">RBC:</label>
            <input type="number" step="any" name="RBC" id="RBC" required placeholder="np. 4.5">
        </div>
        <div class="form-group">
            <label for="HGB">HGB:</label>
            <input type="number" step="any" name="HGB" id="HGB" required placeholder="np. 14">
        </div>
        <div class="form-group">
            <label for="HCT">HCT:</label>
            <input type="number" step="any" name="HCT" id="HCT" required placeholder="np. 42">
        </div>
        <div class="form-group">
            <label for="MCV">MCV:</label>
            <input type="number" step="any" name="MCV" id="MCV" required placeholder="np. 90">
        </div>
        <div class="form-group">
            <label for="MCH">MCH:</label>
            <input type="number" step="any" name="MCH" id="MCH" required placeholder="np. 30">
        </div>
        <div class="form-group">
            <label for="MCHC">MCHC:</label>
            <input type="number" step="any" name="MCHC" id="MCHC" required placeholder="np. 33">
        </div>
        <div class="form-group">
            <label for="RDW">RDW:</label>
            <input type="number" step="any" name="RDW" id="RDW" required placeholder="np. 13">
        </div>
        <div class="form-group">
            <label for="PLT">PLT:</label>
            <input type="number" step="any" name="PLT" id="PLT" required placeholder="np. 250">
        </div>
        <div class="form-group">
            <label for="WBC">WBC:</label>
            <input type="number" step="any" name="WBC" id="WBC" required placeholder="np. 7">
        </div>

        <!-- Nie potrzebujemy tutaj ukrytego pola CSRF, JS doda je do nagłówka -->
        <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /> -->

        <button type="submit">Przewidź</button>
    </form>

    <div id="result"></div>

    <div class="action-links">
        <a href="/anemia/history">Zobacz historię</a>
    </div>
</div>
<!-- SKRYPT SPECYFICZNY DLA FORMULARZA - PRZEKAZYWANY JAKO ${scripts} DO LAYOUTU -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('blood-form');

        if (form) {
            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                const submitButton = this.querySelector('button[type="submit"]');
                const originalText = submitButton ? submitButton.innerText : 'Przewidź'; // Zapisz oryginalny tekst lub domyślny

                // Zmień na loading state
                if (submitButton) {
                    submitButton.innerText = 'Przetwarzanie...';
                    submitButton.disabled = true;
                    submitButton.classList.add('loading');
                }

                const formData = new FormData(this);
                const json = {};
                formData.forEach((value, key) => {
                    json[key] = parseFloat(value);
                });

                document.getElementById('result').innerText = 'Przewidywanie...';

                // Wysyłanie do FastAPI - NIE DODAJEMY CSRF
                console.log('Sending to FastAPI /predict:', JSON.stringify(json));
                try {
                    const response = await fetch('http://localhost:8000/predict', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(json)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('FastAPI error response:', errorText);
                        document.getElementById('result').innerText = `Błąd serwera FastAPI: ${response.status} - ${errorText}`;
                        // Nie resetuj przycisku tutaj, finally to zrobi
                        return; // Stop if FastAPI call fails
                    }

                    const result = await response.json();
                    console.log('FastAPI response:', result);

                    let epicrisisText = result.epicrisis ? `\nEpikryza medyczna: ${result.epicrisis}` : '';

                    document.getElementById('result').innerText = `Przewidziano: ${result.prediction} (pewność: ${result.probability ? result.probability.toFixed(2) : 'N/A'})` + epicrisisText;


                    // Teraz zapis do backendu Spring Boot (/anemia/save)
                    if (result.prediction && result.probability !== undefined) {
                        const resultData = {
                            ...json,
                            prediction: result.prediction,
                            probability: result.probability,
                            epicrisis: result.epicrisis || null
                        };

                        console.log('Saving result to backend:', JSON.stringify(resultData));

                        // POBIERZ TOKEN CSRF Z META TAGÓW I DODAJ NAGŁÓWEK
                        // Zakładamy, że getCsrfToken() jest dostępna globalnie (przeniesiona do global.js)
                        const csrf = typeof getCsrfToken === 'function' ? getCsrfToken() : null; // Bezpieczne wywołanie

                        const headers = {
                            'Content-Type': 'application/json'
                            // Nagłówek CSRF dodamy tylko jeśli token jest dostępny
                        };

                        if (csrf && csrf.token && csrf.parameterName) {
                            // Użyj nazwy parametru i wartości tokenu z meta tagów
                            // CookieCsrfTokenRepository oczekuje nagłówka "X-XSRF-TOKEN"
                            headers['X-XSRF-TOKEN'] = csrf.token; // Domyślna nazwa nagłówka dla Cookie repozytorium
                            console.log(`Using CSRF token in header: ${csrf.token}`);
                        } else {
                            console.warn('CSRF token meta tags not found or getCsrfToken not available. Backend save request will likely fail (403 Forbidden).');
                            document.getElementById('result').innerText += `\nBłąd: Brak tokena bezpieczeństwa. Proszę odświeżyć stronę lub zalogować się ponownie.`;
                            // Możemy zatrzymać fetch, skoro wiemy, że się nie uda
                            // return; // Jeśli chcesz zatrzymać fetch
                        }

                        // Kontynuuj fetch do backendu nawet jeśli brak tokena, żeby zobaczyć błąd 403
                        const saveResponse = await fetch('/anemia/savePredictionResult', {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(resultData)
                        });

                        if (!saveResponse.ok) {
                            if (saveResponse.status === 403) {
                                document.getElementById('result').innerText += `\nBłąd zapisu: Odmowa dostępu (problem z bezpieczeństwem / CSRF).`;
                                console.error('Backend save failed with 403 Forbidden. Likely CSRF issue.');
                            } else {
                                const saveErrorText = await saveResponse.text();
                                console.error('Backend save error response:', saveErrorText);
                                document.getElementById('result').innerText += `\nBłąd zapisu na backendzie: ${saveResponse.status}`;
                            }
                        } else {
                            console.log('Result saved successfully.');
                            document.getElementById('result').innerText += `\nWynik zapisany pomyślnie.`;
                        }

                    } else {
                        console.error('Prediction or probability missing in response from FastAPI', result);
                        document.getElementById('result').innerText = 'Błąd: Nie otrzymano prawidłowej odpowiedzi od serwera predykcji.';
                    }
                } catch (error) {
                    console.error('Fetch error:', error);
                    document.getElementById('result').innerText = `Wystąpił błąd: ${error.message}`;
                } finally { // Zawsze resetuj przycisk po zakończeniu fetch (sukces lub błąd)
                    if (submitButton) {
                        submitButton.innerText = originalText;
                        submitButton.disabled = false;
                        submitButton.classList.remove('loading');
                    }
                }
            });
        }
    });
</script>
</body>
</html>